
<!DOCTYPE html>
<html>
<head>
  <!--
    Kilsbergen MkDocs theme copyright 2019 Ruud van Asseldonk.
    Licensed under the Apache 2.0 license.
    See https://github.com/ruuda/kilsbergen.
  -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Query planning — Noblit</title>
  <!-- Out of the options of rsms.me + Google Fonts, self-hosting, and only
    Google Fonts, the latter is by far the fastest when the docs themselves are
    not on a CDN, even though it's two additional domains to connect to. -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:ital@0;1&display=swap" rel="stylesheet">
  <link href="https://docs.ruuda.nl/noblit/query-planning/" rel="canonical">
  <style>
  /* Inter font family, copyright Rasmus Andersson, licensed under SIL OFL 1.1,
     see https://rsms.me/inter and https://rsms.me/inter/inter.css. */
  @font-face {
    font-family: 'Inter';
    font-style: normal;
    font-weight: 100 900;
    font-display: swap;
    src: url('https://rsms.me/inter/font-files/Inter-roman.var.woff2?v=3.19') format('woff2');
    font-named-instance: 'Regular';
  }
  @font-face {
    font-family: 'Inter';
    font-style: italic;
    font-weight: 100 900;
    font-display: swap;
    src: url('https://rsms.me/inter/font-files/Inter-italic.var.woff2?v=3.19') format('woff2');
    font-named-instance: 'Italic';
  }
  /* Modular scale with exponent 1.7^(1/3). The 1.7 was chosen as the line hight
     that goes well with Inter. Previously I used 1.59, but it was just too tight.
     0.59em
     0.70em
     1.00em
     1.19em
     1.42em
     1.70em
     2.02em
     2.42em
  */
  * { margin: 0; padding: 0; border-spacing: 0; }
  html {
    font-family: Inter, Roboto, sans-serif;
    /*
    Turn on character variant 8 for Inter, which puts serifs on the uppercase I.
    Also turn on variant 1, which has a curved 1.
    Disable contextual alternates for now. There is a bug, either in Inter or
    in Chrome (https://crbug.com/1046095) that causes colons after a <strong> to
    be raised above the baseline.
    */
    font-feature-settings: 'cv01' 1, 'cv08' 1, 'calt' 0;

    font-size: 16px;
    line-height: 1.7em;
    background-color: #fff;
    height: 100%;
  }
  em {
    /* The variable font from Google Fonts uses a slant axis, it does not come
       with a separate true italic. (But Inter doesn't have a true italic either
       way.) */
    font-style: oblique 10deg;
  }
  body {
    height: 100%;
  }
  #content {
    display: grid;
    grid-template-columns: auto 16rem 50rem auto;
    color: #333;
    min-height: 100%;
  }
  #main {
    grid-area: 1 / 3 / 2 / 4;
    padding: 2.2rem;
    padding-left: 4rem;
    padding-right: 4rem;
    overflow: hidden;
  }
  #breadcrumbs {
    margin-bottom: 3rem;
    word-spacing: 0.3em;
    color: #78a;
  }
  #breadcrumbs a {
    word-spacing: 0;
    color: #78a;
  }
  article {
    margin-top: 1.3rem;
  }
  h1, h2, h3 {
    font-weight: 600;
    font-size: 1rem;
    color: #444;
    position: relative;
  }
  h1 {
    font-size: 2rem;
    margin-bottom: 2.1rem;
    line-height: 2.42rem;
    margin-top: -0.35rem;
    margin-bottom: 1.75rem;
  }
  h2 {
    font-size: 1.42rem;
    margin-top: 3.5rem;
    margin-bottom: 1.6rem;
  }
  .headerlink {
    position: absolute;
    left: -0.9em;
    width: 1em;
    opacity: 0.0;
    transition: opacity 0.2s ease-in;
  }
  /* Don't show the link for h1, usually you only have a single h1 at the top
     of the page, so it doesn't make much sense to add an anchor there, and with
     the larger font size, it doesn't fit in a narrow viewport. */
  h2:hover .headerlink, h3:hover .headerlink {
    opacity: 1.0;
  }
  code {
    font-family: 'Roboto Mono', monospace;
    font-size: 0.84rem;
    line-height: 1.5rem;
  }
  h3 > code {
    /* Roboto Mono 500 is about as heavy as Inter semibold (600). */
    font-weight: 500;
  }
  abbr {
    text-transform: uppercase;
    /* Downsize so caps are x-height, and compensate weight loss. */
    font-size: 0.78rem;
    font-weight: 500;
    letter-spacing: 0.05rem;
    /* Prevent abbrs from changing the line height of lines in which they occur. */
    line-height: 0;
  }
  sub, sup {
    /* Don't disturb the line height of normal text. */
    line-height: 0rem;
    font-size: 0.78rem;
    font-weight: 500;
  }
  p > code,
  a > code,
  h3 > code,
  li > code,
  td > code,
  dt > code,
  dd > code {
    background-color: #f0f0f0;
    padding: 0.13rem;
    padding-left: 0.3rem;
    padding-right: 0.3rem;
    border-radius: 0.2rem;
    line-height: 1rem;
  }
  h3 {
    padding-top: 0.9rem;
    padding-bottom: 0.8rem;
  }
  h3 > code {
    margin-left: -0.1rem;
  }
  a {
    color: #36d;
    text-decoration: none;
  }
  p, ul, ol, dl, pre, table {
    /* Same space as line height, leave exactly one line blank. */
    margin-bottom: 1.7rem;
  }
  pre {
    padding-top: 0.8rem;
    padding-bottom: 0.9rem;
    padding-left: 1.19rem;
    padding-right: 0;
    background-color: #f8f8f8;
    border-radius: 0 0.2rem 0.2rem 0;
    border-left: 0.3rem solid #d5d8e0;
    overflow-x: auto;
  }
  pre > code {
    margin-right: 1.41rem;
    color: #555;
  }
  code .k { color: #36d; }
  code .kt, code .nb { color: #d36; }
  code .c1, code .cm { color: #d36; font-style: italic; }
  code .s { color: #c43; }
  ul, ol {
    list-style-type: none;
    counter-reset: item;
  }
  table {
    font-variant-numeric: tabular-nums;
  }
  th, td {
    padding-right: 2rem;
  }
  th {
    text-align: left;
  }
  td > img {
    display: block;
    padding-top: 1em;
    padding-bottom: 1em;
  }
  dl {
    display: grid;
    grid-template-columns: 1fr 4fr;
    grid-column-gap: 2em;
  }
  dl dt {
    text-align: right;
  }
  #main ul li:before {
    color: #555;
    content: '\2022';
    display: inline-block;
    font-weight: 700;
    margin-left: -0.9rem;
    width: 0.9rem;
  }
  #main ul li {
    margin-left: 0.87rem;
  }
  #main ol li:before {
    content: counter(item);
    display: inline-block;
    font-weight: 700;
    width: 0.8rem;
    margin-left: -1.6rem;
    padding-right: 0.8rem;
  }
  #main ol li {
    margin-left: 1.6rem;
    counter-increment: item;
  }
  #nav-prev-next {
    margin-top: 3.4rem;
    padding-bottom: 3.3rem;
  }
  #nav-prev, #nav-next, #repo-link {
    display: inline-block;
  }
  #nav-prev {
    float: left;
  }
  #nav-next, #repo-link {
    float: right;
    text-align: right;
  }
  #nav-prev::before {
    content: '\219e';
    padding-right: 0.5em;
  }
  #nav-next::after {
    content: '\21a0';
    padding-left: 0.5em;
  }
  aside {
    grid-area: 1 / 1 / 2 / 3;
    border-right: 1px solid #eee;
    background-color: #fafafa;
    color: #78a;
  }
  aside nav {
    margin-top: 9rem;
    padding-bottom: 3.4rem;
    width: 14rem;
    float: right;
    /* Put the active chapter border over the sidebar border. */
    margin-right: -1px;
  }
  aside a {
    color: inherit;
  }
  aside .toc-section {
    font-weight: 700;
  }
  aside ul {
    margin-bottom: 0;
  }
  aside li {
    overflow: hidden;
    text-overflow: ellipsis;
  }
  aside li ul {
    padding-top: 0.6rem;
    padding-bottom: 1.1rem;
  }
  aside li.toc-section {
    margin-top: 1.7rem;
  }
  aside li.toc-section {
    color: #36d;
  }
  aside li.current, aside li ul {
    border-right: 0.3em solid #d5d8e0;
    padding-left: 1em;
    margin-left: -1em;
  }
  aside li.toc-chapter.current {
    font-weight: 600;
  }
  aside li.toc-heading {
    padding-left: 1em;
    padding-right: 0.3em;
  }

  @media(max-width: 63rem)
  {
    #content {
      /* Manual implementation of max-width: on narrower viewports,
         auto-size the body. */
      grid-template-columns: 0 16rem auto 0;
    }
  }

  @media(max-width: 1150px)
  {
    html { font-size: 15px; }
  }

  /* Move the sidebar TOC below content at small widths. */
  @media(max-width: 800px)
  {
    #content {
      display: block;
    }
    aside {
      border-top: 1px solid #eee;
      border-right: 0px none;
      padding-top: 1.7em;
    }
    aside nav {
      margin-left: 4em;
      margin-top: 1.7em;
      margin-right: 0;
      float: none;
      width: auto;
    }
    #main {
      padding-bottom: 1.7em;
    }
    /* Now that the TOC is full-width, adding the border on the right to
       highlight the active page is not as clear anymore, it can be far away.
       The current chapter is still in boldface, but that does not work for
       section indexes. So point a guillemet at it as well. */
    aside li.current, aside li ul {
      border-right: 0px none;
      position: relative;
    }
    aside li.current:before {
      content: '\203a';
      position: absolute;
      left: 0;
    }
  }

  /* Use less generous margins for very narrow viewports. */
  @media(max-width: 650px)
  {
    #main {
      padding-left: 2rem;
      padding-right: 2rem;
    }
    aside nav {
      margin-left: 2rem;
      padding-bottom: 2rem;
    }
  }

  @media(max-width: 450px)
  {
    #main {
      padding-left: 1.7em;
      padding-right: 1.7em;
    }
    aside nav {
      margin-left: 1.7em;
    }
  }
  </style>
</head>
<body>
  <div id="content">
    <div id="main">
      <nav id="breadcrumbs">
        <a href="https://docs.ruuda.nl/noblit/">Noblit</a>
         › <a href="../data-model/">Concepts</a> 
         › <a href="./">Query planning</a> 
        <a id="repo-link" href="https://github.com/ruuda/noblit">GitHub</a>
      </nav>
      <article>
        <h1 id="query-planning">Query planning</h1>
<p>Noblit features a straightforward and transparent query planner. On the one
hand, this means that query performance can vary a lot depending on how the
query is structured. On the other hand, this gives you a lot of control over
the query plan, and it ensures predictible performance.</p>
<h2 id="plans">Plans</h2>
<p>Noblit evaluates every query as a set of nested loops that scan over its
indexes. Every where-statement in the query translates to one loop. The query
plan determines the order of those loops, and which index to scan for each loop.</p>
<p>There are three kinds of scan in Noblit:</p>
<ul>
<li><strong>A full index scan.</strong> Such a scan can be used for statements where both the
   entity and the value are unknown. A full index scan provides two variables
   in one loop, but it may have to scan the entire index. For scans over
   attribute-leading indexes, the range is still constrained by attribute.</li>
<li><strong>A partial index scan.</strong> Such a scan can be used for statements where either
   the entity or the value is known, either because it was provided by an outer
   loop, or because it is a constant in the query. A partial index scan can be
   used to find a single datom (for example, to look up the value of an
   attribute for a known entity in the <abbr>EAVT</abbr> index), or to look up a
   range of datoms (for example, to get all entities where an attribute has a
   known value in the <abbr>AVET</abbr> index).</li>
<li><strong>An existence test.</strong> Such a scan can be used to test if a datom exists in
   the database when both the entity and value are known. If it does not exists,
   the loop associated with this scan will have zero iterations (for a given
   iteration of the outer loops).</li>
</ul>
<p>The variables in a statement determine which scan is used:</p>
<ul>
<li>If both the entity and value are variable, and neither of these variables was
   referenced in an earlier statement, a full index scan will be used.</li>
<li>If the statement contains one variable that was not referenced in an earlier
   statement, a partial index scan will be used.</li>
<li>If all variables in the statement were referenced in earlier statements, an
   existence test will be used.</li>
</ul>
<p>Consequently, the order of statements in the query completely specifies what
kind of scans are used, and which variables are provided by every loop. There
is, however, some freedom left to the planner. When a scan can be serviced by
multiple indexes, the planner decides which one to use. For example, to look up
the <code>user.name</code> attribute of a known entity, we could use either
<abbr>EAVT</abbr>, or <abbr>AEVT</abbr>. The former facilitates row access like
a traditional relational database, whereas the latter facilitates column access
like in a column database. It depends on the full query which one is preferred.
If we are <em>only</em> selecting <code>user.name</code>, then column access would be preferred.
But if we are also selecting a few dozen other attributes of the user, then row
access would provide better locality. The planner uses heuristics to select the
index to use for each scan.</p>
<p>TODO: The planner should take schema into account. For example, for a
single-nonunique attribute, we expect a partial <abbr>EAVT</abbr> scan to be
cheaper than a partial <abbr>AVET</abbr> scan. But for a many-unique attribute,
the converse is true.</p>
<h2 id="ordering">Ordering</h2>
<p>TODO: Write about interaction between ordering constraints and the query plan.</p>
<h2 id="advice">Advice</h2>
<p><em>Warning: The advice here is just a guess, and not based on measurements.</em></p>
<p>Given the way that evaluation and the query planner work, it makes sense to
choose a statement order that constrains the ranges scanned as much as possible,
to minimize the number of loop iterations.</p>
<h2 id="query-optimization">Query optimization</h2>
<p>Noblit does provide a query optimizer. Unlike traditional relational databases,
optimization is an explicit operation, it is not implicitly part of every query.
With the burden of runtime query plan optimization out of the way, Noblit can
focus on an off-line optimizer. This has several advantages over runtime query
optimization:</p>
<ul>
<li>Because the runtime query planner is very simple, it is very fast.</li>
<li>There is less of a trade-off between spending time on planning and spending
   time on evaluation. Off-line (in the sense that it runs when instructed to,
   not implicitly as part of every query) we can afford to spend more time
   optimizing.</li>
<li>Now that we can afford to spend more time, the optimizer can <em>measure</em>, it
   does not have to guess. Instead of using statistics to try and estimate the
   cost of a given plan, Noblit can profile the query against your actual
   database.</li>
<li>Now that the optimizer measures, rather than estimates, there is no need to
   keep statistics about the data to base the estimates on. This eliminates a
   lot of complexity.</li>
</ul>
<p>This optimization scheme is made possible by the control that a straightforward
query planner provides. If the planner would perform more advanced runtime
optimization, then there would be less opportunity to tell it exactly what kind
of plan we want.</p>
<p>Of course this optimization scheme has downsides too. In particular, off-line
optimization is not always possible or desirable.</p>
<ul>
<li>For ad-hoc one-off queries, you have to keep performance in mind.</li>
<li>When representative data is unavailable (for example, when you only have a
   test database, not production data), results of off-line optimization may not
   be representative of real-world performance. Rules of thumb can help to
   ensure reasonable plans, but are no substitute for profiling.</li>
<li>There is no way to optimize generated or partially generated queries. What
   you <em>can</em> do though, is optimize a few generated queries, and use the lessons
   learned to tweak the generator.</li>
</ul>
<p>The internals of the query optimizer are outlined in the <a href="../query-optimization/">Query
optimization</a> chapter.</p>
      </article>
      <nav id="nav-prev-next">
        <a id="nav-prev" href="../query/" title="Query">Previous</a>
        <a id="nav-next" href="../examples/key-value-lookup/" title="Key-value lookup">Next</a>
        </nav>
      </div>
    <aside>
      <nav>
        <ul>
        <li class="toc-section"><a href="..">Overview</a></li>
          <li class="toc-section
            "><a href="../data-model/">Concepts</a></li>
          
            <li class="toc-chapter
              "><a href="../data-model/">Data model</a></li>
            
            <li class="toc-chapter
              "><a href="../query/">Query</a></li>
            
            <li class="toc-chapter
               current"><a href="./">Query planning</a></li>
            <li><ul>
                <li class="toc-heading"><a href="#plans">Plans</a></li>
                <li class="toc-heading"><a href="#ordering">Ordering</a></li>
                <li class="toc-heading"><a href="#advice">Advice</a></li>
                <li class="toc-heading"><a href="#query-optimization">Query optimization</a></li>
                </ul></li>
               <li class="toc-section
            "><a href="../examples/key-value-lookup/">Examples</a></li>
          
            <li class="toc-chapter
              "><a href="../examples/key-value-lookup/">Key-value lookup</a></li>
            
            <li class="toc-chapter
              "><a href="../examples/bug-tracker/">Bug tracker</a></li>
            <li class="toc-section
            "><a href="../reference/rust/">Reference</a></li>
          
            <li class="toc-chapter
              "><a href="../reference/rust/">Rust API reference</a></li>
            
            <li class="toc-chapter
              "><a href="../reference/c/">C API reference</a></li>
            <li class="toc-section
            "><a href="../building/">Development</a></li>
          
            <li class="toc-chapter
              "><a href="../building/">Building</a></li>
            
            <li class="toc-chapter
              "><a href="../golden-tests/">Golden tests</a></li>
            
            <li class="toc-chapter
              "><a href="../fuzz-tests/">Fuzz tests</a></li>
            
            <li class="toc-chapter
              "><a href="../resources/">Resources</a></li>
            <li class="toc-section
            "><a href="../architecture/">Internals</a></li>
          
            <li class="toc-chapter
              "><a href="../architecture/">Architecture</a></li>
            
            <li class="toc-chapter
              "><a href="../distributed-operation/">Distributed operation</a></li>
            
            <li class="toc-chapter
              "><a href="../files/">Files</a></li>
            
            <li class="toc-chapter
              "><a href="../htree/">Trees</a></li>
            
            <li class="toc-chapter
              "><a href="../execution/">Execution</a></li>
            
            <li class="toc-chapter
              "><a href="../query-optimization/">Query optimization</a></li>
            </ul>
      </nav>
    </aside>
  </div>
</body>
</html>