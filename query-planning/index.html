
<!DOCTYPE html>
<html>
<head>
  <!--
    Kilsbergen MkDocs theme copyright 2019 Ruud van Asseldonk.
    Licensed under the Apache 2.0 license.
    See https://github.com/ruuda/kilsbergen.
  -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Query planning — Noblit</title>
  <link href="https://rsms.me/inter/inter.css?v=3.3" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Roboto+Mono:400,500" rel="stylesheet">
  <style>
  /* The Inter font family, see https://rsms.me/inter.
     https://rsms.me/inter/#faq-cdn suggests that linking these files directly is fine.
  */
  @font-face {
    font-family: Inter;
    font-style:  normal;
    font-weight: 400;
    src: url("https://rsms.me/inter/font-files/Inter-Regular.woff2?v=3.3") format("woff2"),
         url("https://rsms.me/inter/font-files/Inter-Regular.woff?v=3.3") format("woff");
  }
  @font-face {
    font-family: Inter;
    font-style:  italic;
    font-weight: 400;
    src: url("https://rsms.me/inter/font-files/Inter-Italic.woff2?v=3.3") format("woff2"),
         url("https://rsms.me/inter/font-files/Inter-Italic.woff?v=3.3") format("woff");
  }
  @font-face {
    font-family: Inter;
    font-style:  normal;
    font-weight: 500;
    src: url("https://rsms.me/inter/font-files/Inter-Medium.woff2?v=3.3") format("woff2"),
         url("https://rsms.me/inter/font-files/Inter-Medium.woff?v=3.3") format("woff");
  }
  @font-face {
    font-family: Inter;
    font-style:  normal;
    font-weight: 600;
    src: url("https://rsms.me/inter/font-files/Inter-SemiBold.woff2?v=3.3") format("woff2"),
         url("https://rsms.me/inter/font-files/Inter-SemiBold.woff?v=3.3") format("woff");
  }
  @font-face {
    font-family: Inter;
    font-style:  normal;
    font-weight: 700;
    src: url("https://rsms.me/inter/font-files/Inter-Bold.woff2?v=3.3") format("woff2"),
         url("https://rsms.me/inter/font-files/Inter-Bold.woff?v=3.3") format("woff");
  }
  /* Modular scale with exponent 1.26, about 2^(1/3), so we get 2em in there,
     which is convenient. 1.26 is also close to (golden ratio)^0.5.
     0.63em
     0.80em
     1.00em
     1.26em
     1.59em
     2.00em
  */
  * { margin: 0; padding: 0; border-spacing: 0; }
  html {
    font-family: Inter, Roboto, sans-serif;
    /* Turn on character variant 8 for Inter, which puts serifs on the uppercase I. */
    font-feature-settings: 'cv08' 1;
    font-size: 16px;
    line-height: 1.59em;
    background-color: #fff;
    min-height: 100%;
    position: relative;
  }
  body {
    /* Tricks to make the sidebar full-height on short pages. */
    position: absolute;
    height: 100%;
    width: 100%;
  }
  #content {
    max-width: 66rem;
    margin-left: auto;
    margin-right: auto;
    position: relative;
    color: #333;
    min-height: 100%;
  }
  #main {
    margin-left: 18em;
    margin-right: 2em;
    padding: 2rem;
    overflow: hidden;
  }
  #breadcrumbs {
    margin-bottom: 2.85rem;
    word-spacing: 0.3em;
    color: #78a;
  }
  #breadcrumbs a {
    word-spacing: 0;
    color: #78a;
  }
  article {
    margin-top: 1.3rem;
  }
  h1, h2, h3 {
    font-weight: 600;
    font-size: 1rem;
    color: #444;
    margin-bottom: 1.59rem;
  }
  h1 {
    font-size: 2rem;
    margin-bottom: 1.9rem;
  }
  h2 {
    font-size: 1.59rem;
    margin-top: 3.38rem;
    margin-bottom: 1.39rem;
  }
  code {
    font-family: 'Roboto Mono', monospace;
    font-size: 0.84rem;
    line-height: 1.59rem;
  }
  .mono {
    font-family: 'Roboto Mono', monospace;
  }
  abbr {
    text-transform: uppercase;
    /* Downsize so caps are x-height, and compensate weight loss. */
    font-size: 0.78rem;
    font-weight: 500;
    letter-spacing: 0.05rem;
  }
  sub, sup {
    /* Don't disturb the line height of normal text. */
    line-height: 0rem;
    font-size: 0.78rem;
    font-weight: 500;
  }
  p > code,
  a > code,
  h3 > code,
  li > code,
  td > code {
    background-color: #f0f0f0;
    padding: 0.13rem;
    padding-left: 0.3rem;
    padding-right: 0.3rem;
    border-radius: 0.2rem;
    line-height: 1rem;
  }
  h3 {
    margin-top: 2.29rem;
    margin-bottom: 0.89rem;
  }
  h3 > code {
    margin-left: -0.1rem;
  }
  a {
    color: #36d;
    text-decoration: none;
  }
  p, ul, ol, pre, table {
    /* Same space as line height, leave exactly one line blank. */
    margin-bottom: 1.59em;
  }
  pre {
    padding: 1.41rem;
    padding-right: 0;
    background-color: #f8f8f8;
    border-radius: 0 0.2rem 0.2rem 0;
    border-left: 0.3rem solid #d5d8e0;
    overflow-x: auto;
  }
  pre > code {
    margin-right: 1.41rem;
    color: #555;
  }
  ul, ol {
    list-style-type: none;
    counter-reset: item;
  }
  table {
    font-variant-numeric: tabular-nums;
  }
  th, td {
    padding-right: 2rem;
  }
  th {
    text-align: left;
  }
  #main ul li:before {
    color: #555;
    content: '\2022';
    display: inline-block;
    font-weight: 700;
    margin-left: -0.9rem;
    width: 0.9rem;
  }
  #main ul li {
    margin-left: 0.87rem;
  }
  #main ol li:before {
    content: counter(item);
    display: inline-block;
    font-weight: 700;
    width: 0.8rem;
    margin-left: -1.6rem;
    padding-right: 0.8rem;
  }
  #main ol li {
    margin-left: 1.6rem;
    counter-increment: item;
  }
  #nav-prev-next {
    margin-top: 3.18rem;
    padding-bottom: 3.18rem;
  }
  #nav-prev, #nav-next, #repo-link {
    display: inline-block;
  }
  #nav-prev {
    float: left;
  }
  #nav-next, #repo-link {
    float: right;
    text-align: right;
  }
  #nav-prev::before {
    content: '\219e';
    padding-right: 0.5em;
  }
  #nav-next::after {
    content: '\21a0';
    padding-left: 0.5em;
  }
  aside {
    position: absolute;
    top: 0;
    left: -84em;
    width: 100em;
    border-right: 1px solid #eee;
    background-color: #fafafa;
    height: 100%;
  }
  aside nav {
    margin-top: 8.4rem;
    margin-bottom: 3rem;
    width: 14rem;
    float: right;
    /* Put the active chapter border over the sidebar border. */
    margin-right: -1px;
  }
  aside a {
    color: #78a;
  }
  aside .toc-section {
    font-weight: 700;
  }
  aside ul {
    margin-bottom: 0;
  }
  aside li ul {
    /* This padding destroys the vertical rhythm,
       but I somehow feel it is necessary. */
    padding-top: 0.3rem;
    padding-bottom: 0.4rem;
  }
  aside li.toc-section {
    padding-top: 1.59rem;
  }
  aside li.toc-section a {
    color: #36d;
  }
  aside li.current, aside li ul {
    border-right: 0.3em solid #d5d8e0;
    padding-left: 1em;
    margin-left: -1em;
  }
  aside .current a {
    font-weight: 600;
  }
  aside .current.mono a, h3 > code {
    /* Roboto Mono 500 is about as heavy as Inter semibold (600). */
    font-weight: 500;
  }
  aside li.toc-heading {
    padding-left: 1em;
  }

  @media(max-width: 1150px)
  {
    html { font-size: 15px; }
  }

  /* Move the sidebar TOC below content at small widths. */
  @media(max-width: 800px)
  {
    aside {
      position: relative;
      top: 0;
      left: 0;
      width: 100%;
      height: auto;
      border-top: 1px solid #eee;
      border-right: 0px none;
      overflow: hidden;
    }
    aside nav {
      margin-left: 4em;
      margin-top: 1.59em;
      float: none;
    }
    #main {
      margin-left: 2em;
      padding-bottom: 1.59em;
    }
    aside li.current, aside li ul {
      border-right: 0px none;
    }
  }

  /* Use less generous margins for very narrow viewports. */
  @media(max-width: 650px)
  {
    #main {
      margin-left: 0;
      margin-right: 0;
    }
    aside nav {
      margin-left: 2em;
      margin-bottom: 1.59em;
    }
  }

  @media(max-width: 450px)
  {
    #main {
      padding-left: 1.59em;
      padding-right: 1.59em;
    }
    aside nav {
      margin-left: 1.59em;
    }
  }
  </style>
</head>
<body>
  <div id="content">
    <div id="main">
      <nav id="breadcrumbs">
        <a href="..">Noblit</a>
        › <a href="..">Concepts</a>
  › <a href="./">Query planning</a>
  <a id="repo-link" href="https://github.com/ruuda/noblit/">GitHub</a>
      </nav>
      <article>
        <h1 id="query-planning">Query planning</h1>
<p>Noblit features a straightforward and transparent query planner. On the one
hand, this means that query performance can vary a lot depending on how the
query is structured. On the other hand, this gives you a lot of control over
the query plan, and it ensures predictible performance.</p>
<h2 id="plans">Plans</h2>
<p>Noblit evaluates every query as a set of nested loops that scan over its
indexes. Every where-statement in the query translates to one loop. The query
plan determines the order of those loops, and which index to scan for each loop.</p>
<p>There are three kinds of scan in Noblit:</p>
<ul>
<li><strong>A full index scan.</strong> Such a scan can be used for statements where both the
   entity and the value are unknown. A full index scan provides two variables
   in one loop, but it may have to scan the entire index. For scans over
   attribute-leading indexes, the range is still constrained by attribute.</li>
<li><strong>A partial index scan.</strong> Such a scan can be used for statements where either
   the entity or the value is known, either because it was provided by an outer
   loop, or because it is a constant in the query. A partial index scan can be
   used to find a single datom (for example, to look up the value of an
   attribute for a known entity in the <abbr>EAVT</abbr> index), or to look up a
   range of datoms (for example, to get all entities where an attribute has a
   known value in the <abbr>AVET</abbr> index).</li>
<li><strong>An existence test.</strong> Such a scan can be used to test if a datom exists in
   the database when both the entity and value are known. If it does not exists,
   the loop associated with this can will have zero iterations, and the result
   of the entire query becomes empty.</li>
</ul>
<p>The variables in a statement determine which scan is used:</p>
<ul>
<li>If both the entity and value are variable, and neither of these variables was
   referenced in an earlier statement, a full index scan will be used.</li>
<li>If the statement contains one variable that was not referenced in an earlier
   statement, a partial index scan will be used.</li>
<li>If all variables in the statement were referenced in earlier statements, an
   existence test will be used.</li>
</ul>
<p>Consequently, the order of statements in the query completely specifies what
kind of scans are used, and which variables are provided by every loop. There
is, however, some freedom left to the planner. When a scan can be serviced by
multiple indexes, the planner decides which one to use. For example, to look up
the <code>user.name</code> attribute of a known entity, we could use either
<abbr>EAVT</abbr>, or <abbr>AEVT</abbr>. The former facilitates row access like
a traditional relational database, whereas the latter facilitates column access
like in a column database. It depends on the full query which one is preferred.
If we are <em>only</em> selecting <code>user.name</code>, then column access would be preferred.
But if we are also selecting a few dozen other attributes of the user, then row
access would provide better locality. The planner uses heuristics to select the
index to use for each scan.</p>
<p>TODO: The planner should take schema into account. For example, for a
single-nonunique attribute, we expect a partial <abbr>EAVT</abbr> scan to be
cheaper than a partial <abbr>AVET</abbr> scan. But for a many-unique attribute,
the converse is true.</p>
<h2 id="ordering">Ordering</h2>
<p>TODO: Write about interaction between ordering constraints and the query plan.</p>
<h2 id="advice">Advice</h2>
<p><em>Warning: The advice here is just a guess, and not based on measurements.</em></p>
<p>Given the way that evaluation and the query planner work, it makes sense to
choose a statement order that constrains the ranges scanned as much as possible,
to minimize the number of loop iterations.</p>
<h2 id="query-optimization">Query optimization</h2>
<p><em>Vaporware warning: This is only and idea, it has not been implemented.</em></p>
<p>Noblit does provide a query optimizer. Unlike traditional relational databases,
optimization is an explicit operation, it is not implicitly part of every query.
With the burden of runtime query plan optimization out of the way, Noblit can
focus on an off-line optimizer. This has several advantages over runtime query
optimization:</p>
<ul>
<li>Because the runtime query planner is very simple, it is very fast.</li>
<li>There is less of a trade-off between spending time on planning and spending
   time on evaluation. Off-line (in the sense that it runs when instructed to,
   not implicitly as part of every query) we can afford to spend more time
   optimizing.</li>
<li>Now that we can afford to spend more time, the optimizer can <em>measure</em>, it
   does not have to guess. Instead of using statistics to try and estimate the
   cost of a given plan, Noblit can profile the query against your actual
   database.</li>
<li>Now that the optimizer measures, rather than estimates, there is no need to
   keep statistics about the data to base the estimates on. This eliminates a
   lot of complexity.</li>
</ul>
<p>This optimization scheme is made possible by the control that a straightforward
query planner provides. If the planner would perform more advanced runtime
optimization, then there would be less opportunity to tell it exactly what kind
of plan we want.</p>
<p>Of course this optimization scheme has downsides too. In particular, off-line
optimization is not always possible or desirable.</p>
<ul>
<li>For ad-hoc one-off queries, you have to keep performance in mind.</li>
<li>When representative data is unavailable (for example, when you only have a
   test database, not production data), results of off-line optimization may not
   be representative of real-world performance. Rules of thumb can help to
   ensure reasonable plans, but are no substitute for profiling.</li>
<li>There is no way to optimize generated or partially generated queries. What
   you <em>can</em> do though, is optimize a few generated queries, and use the lessons
   learned to tweak the generator.</li>
</ul>
      </article>
      <nav id="nav-prev-next">
        <a id="nav-prev" href="../query/" title="Query">Previous</a>
        <a id="nav-next" href="../examples/bug-tracker/" title="Bug tracker">Next</a>
        </nav>
      </div>
    <aside>
      <nav>
        <ul>
        <li class="toc-section"><a href="..">Overview</a></li>
          <li class="toc-section"><a href="../data-model/">Concepts</a></li>
          <li class="toc-chapter
              "><a href="../data-model/">Data model</a></li>
            <li class="toc-chapter
              "><a href="../query/">Query</a></li>
            <li class="toc-chapter
               current"><a href="./">Query planning</a></li>
            <li><ul>
                <li class="toc-heading"><a href="#plans">Plans</a></li>
                <li class="toc-heading"><a href="#ordering">Ordering</a></li>
                <li class="toc-heading"><a href="#advice">Advice</a></li>
                <li class="toc-heading"><a href="#query-optimization">Query optimization</a></li>
                </ul></li>
               <li class="toc-section"><a href="../examples/bug-tracker/">Examples</a></li>
          <li class="toc-chapter
              "><a href="../examples/bug-tracker/">Bug tracker</a></li>
            <li class="toc-section"><a href="../building/">Development</a></li>
          <li class="toc-chapter
              "><a href="../building/">Building</a></li>
            <li class="toc-chapter
              "><a href="../golden-tests/">Golden tests</a></li>
            <li class="toc-chapter
              "><a href="../resources/">Resources</a></li>
            <li class="toc-section"><a href="../files/">Internals</a></li>
          <li class="toc-chapter
              "><a href="../files/">Files</a></li>
            <li class="toc-chapter
              "><a href="../htree/">Trees</a></li>
            <li class="toc-chapter
              "><a href="../execution/">Execution</a></li>
            </ul>
      </nav>
    </aside>
  </div>
</body>
</html>