
<!DOCTYPE html>
<html>
<head>
  <!--
    Kilsbergen MkDocs theme copyright 2019 Ruud van Asseldonk.
    Licensed under the Apache 2.0 license.
    See https://github.com/ruuda/kilsbergen.
  -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Query — Noblit</title>
  <link href="https://fonts.googleapis.com/css?family=Roboto+Mono:400,500" rel="stylesheet">
  <style>
  /* The Inter font family, see https://rsms.me/inter.
     https://rsms.me/inter/#faq-cdn suggests that linking these files directly is fine.
  */
  @font-face {
    font-family: Inter;
    font-style:  normal;
    font-weight: 400;
    src: url("https://rsms.me/inter/font-files/Inter-Regular.woff2?v=3.11") format("woff2"),
         url("https://rsms.me/inter/font-files/Inter-Regular.woff?v=3.11") format("woff");
  }
  @font-face {
    font-family: Inter;
    font-style:  italic;
    font-weight: 400;
    src: url("https://rsms.me/inter/font-files/Inter-Italic.woff2?v=3.11") format("woff2"),
         url("https://rsms.me/inter/font-files/Inter-Italic.woff?v=3.11") format("woff");
  }
  @font-face {
    font-family: Inter;
    font-style:  normal;
    font-weight: 500;
    src: url("https://rsms.me/inter/font-files/Inter-Medium.woff2?v=3.11") format("woff2"),
         url("https://rsms.me/inter/font-files/Inter-Medium.woff?v=3.11") format("woff");
  }
  @font-face {
    font-family: Inter;
    font-style:  normal;
    font-weight: 600;
    src: url("https://rsms.me/inter/font-files/Inter-SemiBold.woff2?v=3.11") format("woff2"),
         url("https://rsms.me/inter/font-files/Inter-SemiBold.woff?v=3.11") format("woff");
  }
  @font-face {
    font-family: Inter;
    font-style:  normal;
    font-weight: 700;
    src: url("https://rsms.me/inter/font-files/Inter-Bold.woff2?v=3.11") format("woff2"),
         url("https://rsms.me/inter/font-files/Inter-Bold.woff?v=3.11") format("woff");
  }
  /* Modular scale with exponent 1.26, about 2^(1/3), so we get 2em in there,
     which is convenient. 1.26 is also close to (golden ratio)^0.5.
     0.63em
     0.80em
     1.00em
     1.26em
     1.59em
     2.00em
  */
  * { margin: 0; padding: 0; border-spacing: 0; }
  html {
    font-family: Inter, Roboto, sans-serif;
    /*
    Turn on character variant 8 for Inter, which puts serifs on the uppercase I.
    Also turn on variant 1, which has a curved 1.
    Disable contextual alternates for now. There is a bug, either in Inter or
    in Chrome (https://crbug.com/1046095) that causes colons after a <strong> to
    be raised above the baseline.
    */
    font-feature-settings: 'cv01' 1, 'cv08' 1, 'calt' 0;

    font-size: 16px;
    line-height: 1.59em;
    background-color: #fff;
    height: 100%;
  }
  body {
    height: 100%;
  }
  #content {
    display: grid;
    grid-template-columns: auto 16rem 50rem auto;
    color: #333;
    min-height: 100%;
  }
  #main {
    grid-area: 1 / 3 / 2 / 4;
    padding: 2rem;
    padding-left: 4rem;
    padding-right: 4rem;
    overflow: hidden;
  }
  #breadcrumbs {
    margin-bottom: 2.85rem;
    word-spacing: 0.3em;
    color: #78a;
  }
  #breadcrumbs a {
    word-spacing: 0;
    color: #78a;
  }
  article {
    margin-top: 1.3rem;
  }
  h1, h2, h3 {
    font-weight: 600;
    font-size: 1rem;
    color: #444;
    margin-bottom: 1.59rem;
  }
  h1 {
    font-size: 2rem;
    margin-bottom: 1.9rem;
  }
  h2 {
    font-size: 1.59rem;
    margin-top: 3.38rem;
    margin-bottom: 1.39rem;
  }
  code {
    font-family: 'Roboto Mono', monospace;
    font-size: 0.84rem;
    line-height: 1.59rem;
  }
  h3 > code {
    /* Roboto Mono 500 is about as heavy as Inter semibold (600). */
    font-weight: 500;
  }
  abbr {
    text-transform: uppercase;
    /* Downsize so caps are x-height, and compensate weight loss. */
    font-size: 0.78rem;
    font-weight: 500;
    letter-spacing: 0.05rem;
  }
  sub, sup {
    /* Don't disturb the line height of normal text. */
    line-height: 0rem;
    font-size: 0.78rem;
    font-weight: 500;
  }
  p > code,
  a > code,
  h3 > code,
  li > code,
  td > code {
    background-color: #f0f0f0;
    padding: 0.13rem;
    padding-left: 0.3rem;
    padding-right: 0.3rem;
    border-radius: 0.2rem;
    line-height: 1rem;
  }
  h3 {
    margin-top: 2.29rem;
    margin-bottom: 0.89rem;
  }
  h3 > code {
    margin-left: -0.1rem;
  }
  a {
    color: #36d;
    text-decoration: none;
  }
  p, ul, ol, pre, table {
    /* Same space as line height, leave exactly one line blank. */
    margin-bottom: 1.59em;
  }
  pre {
    padding: 1.41rem;
    padding-right: 0;
    background-color: #f8f8f8;
    border-radius: 0 0.2rem 0.2rem 0;
    border-left: 0.3rem solid #d5d8e0;
    overflow-x: auto;
  }
  pre > code {
    margin-right: 1.41rem;
    color: #555;
  }
  ul, ol {
    list-style-type: none;
    counter-reset: item;
  }
  table {
    font-variant-numeric: tabular-nums;
  }
  th, td {
    padding-right: 2rem;
  }
  th {
    text-align: left;
  }
  td > img {
    display: block;
    padding-top: 1em;
    padding-bottom: 1em;
  }
  #main ul li:before {
    color: #555;
    content: '\2022';
    display: inline-block;
    font-weight: 700;
    margin-left: -0.9rem;
    width: 0.9rem;
  }
  #main ul li {
    margin-left: 0.87rem;
  }
  #main ol li:before {
    content: counter(item);
    display: inline-block;
    font-weight: 700;
    width: 0.8rem;
    margin-left: -1.6rem;
    padding-right: 0.8rem;
  }
  #main ol li {
    margin-left: 1.6rem;
    counter-increment: item;
  }
  #nav-prev-next {
    margin-top: 3.18rem;
    padding-bottom: 3.18rem;
  }
  #nav-prev, #nav-next, #repo-link {
    display: inline-block;
  }
  #nav-prev {
    float: left;
  }
  #nav-next, #repo-link {
    float: right;
    text-align: right;
  }
  #nav-prev::before {
    content: '\219e';
    padding-right: 0.5em;
  }
  #nav-next::after {
    content: '\21a0';
    padding-left: 0.5em;
  }
  aside {
    grid-area: 1 / 1 / 2 / 3;
    border-right: 1px solid #eee;
    background-color: #fafafa;
  }
  aside nav {
    margin-top: 8.4rem;
    padding-bottom: 3rem;
    width: 14rem;
    float: right;
    /* Put the active chapter border over the sidebar border. */
    margin-right: -1px;
  }
  aside a {
    color: #78a;
  }
  aside .toc-section {
    font-weight: 700;
  }
  aside ul {
    margin-bottom: 0;
  }
  aside li ul {
    /* This padding destroys the vertical rhythm,
       but I somehow feel it is necessary. */
    padding-top: 0.3rem;
    padding-bottom: 0.4rem;
  }
  aside li.toc-section {
    padding-top: 1.59rem;
  }
  aside li.toc-section a {
    color: #36d;
  }
  aside li.current, aside li ul {
    border-right: 0.3em solid #d5d8e0;
    padding-left: 1em;
    margin-left: -1em;
  }
  aside .current a {
    font-weight: 600;
  }
  aside li.toc-heading {
    padding-left: 1em;
  }

  @media(max-width: 59.5rem)
  {
    #content {
      /* Manual implementation of max-width: on narrower viewports,
         auto-size the body. */
      grid-template-columns: 0 16rem auto 0;
    }
  }

  @media(max-width: 1150px)
  {
    html { font-size: 15px; }
  }

  /* Move the sidebar TOC below content at small widths. */
  @media(max-width: 800px)
  {
    #content {
      display: block;
    }
    aside {
      border-top: 1px solid #eee;
      border-right: 0px none;
    }
    aside nav {
      margin-left: 4em;
      margin-top: 1.59em;
      float: none;
    }
    #main {
      padding-bottom: 1.59em;
    }
    aside li.current, aside li ul {
      border-right: 0px none;
    }
  }

  /* Use less generous margins for very narrow viewports. */
  @media(max-width: 650px)
  {
    #main {
      padding-left: 2rem;
      padding-right: 2rem;
    }
    aside nav {
      margin-left: 2rem;
      padding-bottom: 2rem;
    }
  }

  @media(max-width: 450px)
  {
    #main {
      padding-left: 1.59em;
      padding-right: 1.59em;
    }
    aside nav {
      margin-left: 1.59em;
    }
  }
  </style>
</head>
<body>
  <div id="content">
    <div id="main">
      <nav id="breadcrumbs">
        <a href="..">Noblit</a>
        › <a href="..">Concepts</a>
  › <a href="./">Query</a>
  <a id="repo-link" href="https://github.com/ruuda/noblit/">GitHub</a>
      </nav>
      <article>
        <h1 id="query">Query</h1>
<p>Queries in Noblit are declarative, based on logic programming, inspired by
Datalog. Queries consist of a number of statements (logical claims, not steps in
a procedure) that relate variables. The result of a query are the possible
assignments of values to the variables.</p>
<h2 id="structure">Structure</h2>
<p>A query has three parts:</p>
<ul>
<li><strong>Where</strong>, a collection of statements that are true of the answers.</li>
<li><strong>Select</strong>, the variables whose values will be returned.</li>
<li><strong>Order by</strong>, to control ordering. (Not implemented yet.)</li>
</ul>
<p>The where-part of a query consists of (entity, attribute, value) tuples. The
entity and value can be variables or constants. By convention, below we use
single-character variable names to refer to entities, and full names to refer
to other types of values (strings and integers).</p>
<h2 id="example">Example</h2>
<p>As an example, select all tracks by Muse from a music database, ordered by
release date and then by track number:</p>
<pre><code>where
  a artist.name "Muse"
  b album.artist a
  b album.title album_title
  b album.release.year year
  b album.release.month month
  b album.release.day day
  t track.album b
  t track.number number
  t track.title track_title
select
  number, track_title, album_title
order by
  year, month, day, number
</code></pre>
<p>Select all tracks titled "One", their artist, and release year:</p>
<pre><code>where
  t track.title "One"
  t track.album b
  b album.release.year year
  b album.artist a
  a artist.name artist
select
  artist, year
</code></pre>
<h2 id="semantics">Semantics</h2>
<p>To answer a query, identify every variable in the query with the set of values
it can assume. The answer to the query is the cartesian product of these sets,
filtered such that for every tuple in the product, a datom exists in the
database for each of the where-statements. For example, consider the following
database of (entity, attribute, value) pairs:</p>
<pre><code>1 person.name "Henk"
2 person.name "Klaas"
3 person.name "Piet"
1 person.age 32
2 person.age 54
3 person.age 32
</code></pre>
<p>Suppose we want to find all pairs of people with the same age. We would query:</p>
<pre><code>where
  p person.age a
  q person.age a
  p person.name p_name
  q person.name q_name
select
  p_name, q_name
</code></pre>
<p>This query has five variables. Taking the Cartesian product, we get:</p>
<table>
<thead>
<tr>
<th>p</th>
<th>p_name</th>
<th>q</th>
<th>q_name</th>
<th>a</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>Henk</td>
<td>1</td>
<td>Henk</td>
<td>32</td>
</tr>
<tr>
<td>2</td>
<td>Henk</td>
<td>1</td>
<td>Henk</td>
<td>32</td>
</tr>
<tr>
<td></td>
<td>...</td>
<td></td>
<td>...</td>
<td></td>
</tr>
<tr>
<td>3</td>
<td>Piet</td>
<td>3</td>
<td>Piet</td>
<td>54</td>
</tr>
</tbody>
</table>
<p>Filtering first by the first and last two statements (<code>p person.age a</code>,
<code>p person.name p_name</code>, and <code>q person.name q_name</code>), we are left with only
the tuples where <code>a</code> is the age of person <code>p</code>, and where the names and the
person ids match:</p>
<table>
<thead>
<tr>
<th>p</th>
<th>p_name</th>
<th>q</th>
<th>q_name</th>
<th>a</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>Henk</td>
<td>1</td>
<td>Henk</td>
<td>32</td>
</tr>
<tr>
<td>2</td>
<td>Klaas</td>
<td>1</td>
<td>Henk</td>
<td>52</td>
</tr>
<tr>
<td></td>
<td>...</td>
<td></td>
<td>...</td>
<td></td>
</tr>
<tr>
<td>3</td>
<td>Piet</td>
<td>3</td>
<td>Piet</td>
<td>32</td>
</tr>
</tbody>
</table>
<p>Filtering by the remaining statement <code>q person.age a</code>, we find all tuples that
satisfy the query:</p>
<table>
<thead>
<tr>
<th>p</th>
<th>p_name</th>
<th>q</th>
<th>q_name</th>
<th>a</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>Henk</td>
<td>1</td>
<td>Henk</td>
<td>32</td>
</tr>
<tr>
<td>3</td>
<td>Piet</td>
<td>1</td>
<td>Henk</td>
<td>32</td>
</tr>
<tr>
<td>2</td>
<td>Klaas</td>
<td>2</td>
<td>Klaas</td>
<td>52</td>
</tr>
<tr>
<td>3</td>
<td>Henk</td>
<td>3</td>
<td>Piet</td>
<td>32</td>
</tr>
<tr>
<td>3</td>
<td>Piet</td>
<td>3</td>
<td>Piet</td>
<td>32</td>
</tr>
</tbody>
</table>
<p>Finally, keeping only the selected columns yields the answer:</p>
<table>
<thead>
<tr>
<th>p_name</th>
<th>q_name</th>
</tr>
</thead>
<tbody>
<tr>
<td>Henk</td>
<td>Henk</td>
</tr>
<tr>
<td>Piet</td>
<td>Henk</td>
</tr>
<tr>
<td>Klaas</td>
<td>Klaas</td>
</tr>
<tr>
<td>Henk</td>
<td>Piet</td>
</tr>
<tr>
<td>Piet</td>
<td>Piet</td>
</tr>
</tbody>
</table>
<h2 id="aggregations">Aggregations</h2>
<p><em>Note: This is an idea, it has not been implemented yet.</em></p>
<p>For aggregations such as <em>sum</em>, <em>count</em>, and <em>min</em> and <em>max</em>, we put the
aggregate in the select part of the query. For example, in an order database,
we could select the total amount billed in 2020:</p>
<pre><code>where
  i invoice.year 2020
  i invoice.amount_eur amount_eur
select
  sum(amount_eur)
</code></pre>
<p>When mixing aggregates and non-aggregates, aggregates are taken over the
group keyed on the non-aggregate variables. For example, we may compute the
total amount billed per year:</p>
<pre><code>where
  i invoice.year year
  i invoice.amount_eur amount_eur
select
  year, sum(amount_eur)
</code></pre>
<p>The above query will return one row per distinct year, it will not return the
same year twice. This is in contrast to the non-aggregate query, which would
return a row for every invoice entity.</p>
<p>Aggregates can always be streamed, the grouping behavior does never cause a
collection to be materialized in memory. This is because a query is evaluated as
a nested loop. Non-aggregated variables are on the outer loops, and aggregated
variables on the inner loops. This means that we visit one group key at a time.</p>
      </article>
      <nav id="nav-prev-next">
        <a id="nav-prev" href="../data-model/" title="Data model">Previous</a>
        <a id="nav-next" href="../query-planning/" title="Query planning">Next</a>
        </nav>
      </div>
    <aside>
      <nav>
        <ul>
        <li class="toc-section"><a href="..">Overview</a></li>
          <li class="toc-section"><a href="../data-model/">Concepts</a></li>
          <li class="toc-chapter
              "><a href="../data-model/">Data model</a></li>
            <li class="toc-chapter
               current"><a href="./">Query</a></li>
            <li><ul>
                <li class="toc-heading"><a href="#structure">Structure</a></li>
                <li class="toc-heading"><a href="#example">Example</a></li>
                <li class="toc-heading"><a href="#semantics">Semantics</a></li>
                <li class="toc-heading"><a href="#aggregations">Aggregations</a></li>
                </ul></li>
               <li class="toc-chapter
              "><a href="../query-planning/">Query planning</a></li>
            <li class="toc-section"><a href="../examples/bug-tracker/">Examples</a></li>
          <li class="toc-chapter
              "><a href="../examples/bug-tracker/">Bug tracker</a></li>
            <li class="toc-section"><a href="../building/">Development</a></li>
          <li class="toc-chapter
              "><a href="../building/">Building</a></li>
            <li class="toc-chapter
              "><a href="../golden-tests/">Golden tests</a></li>
            <li class="toc-chapter
              "><a href="../resources/">Resources</a></li>
            <li class="toc-section"><a href="../files/">Internals</a></li>
          <li class="toc-chapter
              "><a href="../files/">Files</a></li>
            <li class="toc-chapter
              "><a href="../htree/">Trees</a></li>
            <li class="toc-chapter
              "><a href="../execution/">Execution</a></li>
            <li class="toc-chapter
              "><a href="../query-optimization/">Query optimization</a></li>
            </ul>
      </nav>
    </aside>
  </div>
</body>
</html>